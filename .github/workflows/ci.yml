---
name: ci

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  shell:
    name: shell
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Bash syntax check
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          files=(scripts/**/*.sh)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No shell scripts found under scripts/**/*.sh, skipping."
            exit 0
          fi

          for f in "${files[@]}"; do
            echo "bash -n $f"
            bash -n "$f"
          done

      - name: Shellcheck
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          files=(scripts/**/*.sh)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No shell scripts found under scripts/**/*.sh, skipping."
            exit 0
          fi

          shellcheck "${files[@]}"

      - name: Setup shfmt
        uses: mfinelli/setup-shfmt@v3

      - name: Enforce shfmt formatting
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          files=(scripts/**/*.sh)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No shell scripts found under scripts/**/*.sh, skipping."
            exit 0
          fi

          shfmt -d -i 2 -ci -sr "${files[@]}"

  unit-tests:
    name: unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run unit tests (show Bats output)
        shell: bash
        run: |
          set -euo pipefail
          "$GITHUB_WORKSPACE/tests/bin/run-bats-unit.sh"

  integration-tests:
    name: integration tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Run integration tests (show Bats output)
        shell: bash
        run: |
          set -euo pipefail
          "$GITHUB_WORKSPACE/tests/bin/run-bats-integration.sh"

  coverage:
    name: coverage (kcov)
    runs-on: ubuntu-22.04
    needs: [integration-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install kcov
        run: |
          sudo apt-get update
          # Ensure universe is enabled (kcov lives there on Ubuntu 22.04).
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y universe
          sudo apt-get update
          sudo apt-get install -y kcov strace

      - name: Run tests under kcov
        timeout-minutes: 15
        shell: bash
        run: |
          set -euo pipefail
          KCOV_ALLOW_NONZERO_WITH_REPORT=1 "$GITHUB_WORKSPACE/tests/bin/run-bats-kcov.sh"

      - name: Show kcov output paths
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Listing coverage/ (if present)"
          ls -la coverage || true
          echo "Searching for coverage.json under coverage/"
          find coverage -maxdepth 4 -name coverage.json -print 2>/dev/null || true
          echo "Searching for kcov logs under coverage/"
          find coverage -maxdepth 2 -name '*.log' -print 2>/dev/null || true

          for f in coverage/*.log; do
            [ -f "$f" ] || continue
            echo "--- $f (last 200 lines) ---"
            tail -n 200 "$f" || true
          done

      - name: Upload kcov coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kcov-coverage
          path: coverage/
          if-no-files-found: warn

      - name: Upload kcov logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kcov-logs
          path: |
            coverage/*.log
            coverage/**/*.log
            coverage/*.strace
            coverage/**/*.strace
          if-no-files-found: warn

      - name: Enforce 100% line coverage
        shell: bash
        run: |
          set -euo pipefail
          "$GITHUB_WORKSPACE/tests/bin/assert-kcov-100.sh"

  yaml:
    name: yaml
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint

      - name: Yamllint
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          files=(
            .github/**/*.yml
            .github/**/*.yaml
            cloud-init/**/*.yml
            cloud-init/**/*.yaml
            examples/**/*.yml
            examples/**/*.yaml
          )

          existing=()
          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              existing+=("$f")
            fi
          done

          if [ ${#existing[@]} -eq 0 ]; then
            echo "No YAML files found in expected locations, skipping."
            exit 0
          fi

          yamllint -c .yamllint.yml "${existing[@]}"

  systemd:
    name: systemd
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare ExecStart stubs for verification
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          # systemd-analyze verify checks that ExecStart binaries exist.
          # In CI we verify unit file syntax/semantics without installing the appliance.
          # Create minimal executable stubs for referenced /usr/local paths.
          execs=()
          while IFS= read -r line; do
            [[ -n "$line" ]] || continue
            execs+=("${line#*=}")
          done < <(grep -hoE '^(ExecStart|ExecStartPre)=[^ ]+' systemd/**/*.service 2>/dev/null | sort -u || true)

          for exe in "${execs[@]}"; do
            case "$exe" in
              /usr/local/*)
                sudo mkdir -p "$(dirname "$exe")"
                printf '%s\n' '#!/usr/bin/env bash' 'exit 0' | sudo tee "$exe" >/dev/null
                sudo chmod +x "$exe"
                ;;
            esac
          done

      - name: Verify systemd units
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          units=(
            systemd/**/*.service
            systemd/**/*.timer
            systemd/**/*.target
            systemd/**/*.path
            systemd/**/*.socket
            systemd/**/*.mount
          )

          existing=()
          for u in "${units[@]}"; do
            if [ -f "$u" ]; then
              existing+=("$u")
            fi
          done

          if [ ${#existing[@]} -eq 0 ]; then
            echo "No systemd unit files found under systemd/, skipping."
            exit 0
          fi

          for u in "${existing[@]}"; do
            echo "systemd-analyze verify $u"
            systemd-analyze verify "$u"
          done

  markdown:
    name: markdown
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install markdownlint
        run: |
          npm install -g markdownlint-cli

      - name: Markdownlint
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          files=(
            README.md
            CHANGELOG.md
            CONTRIBUTING.md
            CODE_OF_CONDUCT.md
            docs/**/*.md
          )

          existing=()
          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              existing+=("$f")
            fi
          done

          if [ ${#existing[@]} -eq 0 ]; then
            echo "No markdown files found, skipping."
            exit 0
          fi

          markdownlint -c .markdownlint.json "${existing[@]}"
